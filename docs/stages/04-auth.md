# Этап 4: Аутентификация и авторизация

## Цель этапа
Реализовать безопасную систему аутентификации с JWT токенами и управлением пользователями.

## 4.1 JWT токены
- [ ] Добавить зависимости для JWT (`github.com/golang-jwt/jwt`)
- [ ] Создать сервис для генерации access/refresh токенов
- [ ] Реализовать middleware для проверки JWT токенов

### Детали реализации
- Access токен: срок жизни 15 минут
- Refresh токен: срок жизни 7 дней
- Использовать HMAC SHA256 для подписи токенов
- Middleware должен проверять токен и извлекать user_id

## 4.2 Регистрация и логин
- [ ] Создать хендлер для регистрации POST `/api/v1/auth/register`
- [ ] Создать хендлер для логина POST `/api/v1/auth/login`
- [ ] Добавить валидацию входных данных
- [ ] Реализовать хеширование паролей с bcrypt

### Детали реализации
- Валидация email и пароля (минимум 8 символов)
- Проверка уникальности email при регистрации
- Использовать bcrypt с cost 12 для хеширования паролей
- Возвращать access и refresh токены при успешной авторизации

### Примеры запросов
```json
// POST /api/v1/auth/register
{
  "email": "user@example.com",
  "password": "securepassword123"
}

// POST /api/v1/auth/login
{
  "email": "user@example.com",
  "password": "securepassword123"
}

// Ответ
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "expires_in": 900
}
```

## 4.3 Refresh токены
- [ ] Создать хендлер для обновления токенов POST `/api/v1/auth/refresh`
- [ ] Реализовать хранение refresh токенов в базе
- [ ] Добавить логику отзыва токенов

### Детали реализации
- Хранить refresh токены в отдельной таблице с привязкой к пользователю
- При обновлении токенов генерировать новые access и refresh токены
- Старые refresh токены должны быть отозваны
- Добавить endpoint для logout с отзывом токенов

## Критерии готовности
- [ ] Регистрация и логин работают корректно
- [ ] JWT middleware защищает приватные endpoints
- [ ] Refresh токены работают и отзываются корректно
- [ ] Пароли хешируются безопасно
- [ ] Валидация входных данных работает

## Время выполнения
Ориентировочно: 2-3 дня

## Предыдущий этап
[Этап 3: База данных](./03-database.md)

## Следующий этап
[Этап 5: API v1](./05-api-v1.md)
